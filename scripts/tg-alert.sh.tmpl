#!/usr/bin/env bash

# === –ó–ê–ì–†–£–ó–ö–ê .env ===
ENV_PATH="{{ .chezmoi.homeDir }}/scripts/.env"
if [ -f "$ENV_PATH" ]; then
  set -o allexport
  source "$ENV_PATH"
  set +o allexport
else
  echo "‚ùå .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $ENV_PATH" >&2
  exit 1
fi

# === –ö–û–ù–°–¢–ê–ù–¢–´ ===
MAX_CHARS=3800  # –º–∞–∫—Å–∏–º—É–º —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏

# === –ü–ê–†–°–ò–ú –ê–†–ì–£–ú–ï–ù–¢–´ ===
MESSAGE_TEXT=""
while getopts "m:" opt; do
  case ${opt} in
    m ) MESSAGE_TEXT="$OPTARG" ;;
  esac
done

# === –û–ë–†–ê–ë–û–¢–ö–ê STDIN ===
STDIN_CONTENT=""
if ! [ -t 0 ]; then
  STDIN_CONTENT=$(cat)
  STDIN_CONTENT="${STDIN_CONTENT: -$MAX_CHARS}"  # –ø–æ—Å–ª–µ–¥–Ω–∏–µ $MAX_CHARS —Å–∏–º–≤–æ–ª–æ–≤
fi

# === –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø ===
USER_NAME="$(whoami)"
HOST_NAME="$(hostname)"
TELEGRAM_MSG="üîî–ù–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç ${USER_NAME}@${HOST_NAME}"

if [ -n "$MESSAGE_TEXT" ]; then
  TELEGRAM_MSG+="
\"$MESSAGE_TEXT\""
fi

if [ -n "$STDIN_CONTENT" ]; then
  TELEGRAM_MSG+="

‚ö†Ô∏è –ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ ${MAX_CHARS} —Å–∏–º–≤–æ–ª–æ–≤ –≤—Ö–æ–¥—è—â–µ–≥–æ –≤—ã–≤–æ–¥–∞:

\`\`\`
$STDIN_CONTENT
\`\`\`"
fi

# === –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø ===
curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
  -d chat_id="$CHAT_ID" \
  -d text="$TELEGRAM_MSG" \
  -d parse_mode="Markdown"
