- name: Machine setup
  hosts: localhost
  connection: local
  gather_facts: true
  tasks:
    - name: Determine Homebrew path
      set_fact:
        brew_path: "{{ '/opt/homebrew/bin/brew' if ansible_architecture == 'arm64' else '/usr/local/bin/brew' }}"

    - name: Check if Homebrew is installed
      stat:
        path: "{{ brew_path }}"
      register: brew_check

    - name: Install Homebrew if missing
      shell: |
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      args:
        creates: "{{ brew_path }}"
      when: not brew_check.stat.exists and ansible_os_family == "Darwin"
    
    - name: Tap FelixKratz/formulae
      community.general.homebrew_tap:
        name: FelixKratz/formulae
        state: present
      when: ansible_os_family == "Darwin"

    - name: Install Homebrew formulae
      community.general.homebrew:
        name:
          - colima
          - docker
          - htop
          - neovim
          - ripgrep
          - tmux
          - age
          - borders
          - sketchybar
        state: present
      when: ansible_os_family == "Darwin"

    - name: Install Homebrew casks
      community.general.homebrew_cask:
        name:
          - aerospace
          - font-jetbrains-mono-nerd-font
          - font-hack-nerd-font
          - linearmouse
          - maccy
          - wezterm
          - raycast
        state: present
      when: ansible_os_family == "Darwin"
      